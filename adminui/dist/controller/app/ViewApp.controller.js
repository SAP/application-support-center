sap.ui.define(["../BaseController"],function(e){return e.extend("asc.admin.controller.app.ViewApp",{onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("viewapp").attachPatternMatched(this._onAppMatched,this)},_onAppMatched:function(e){this._app=e.getParameter("arguments").app||this._app||"0";this.getView().bindElement({path:"/"+this._app,model:"apps"});this._appDetail=this.getView().getModel("apps").getProperty("/"+this._app);if(this._appDetail){this.onGetAppHelp(this._appDetail.app_id);this.onGetAppReleases(this._appDetail.app_id);this.onGetAppKeywords(this._appDetail.app_id);this.onGetAppAnnouncements(this._appDetail.app_id);this.onGetAppContacts(this._appDetail.app_id,true);if(this._appDetail.usage_tracking_id){this.onGetAppUsageData(this._appDetail.app_id,this._appDetail.usage_tracking_id)}if(this.getOwnerComponent().getModel("selected_app")==undefined){var t=new sap.ui.model.json.JSONModel;t.setData(this._appDetail);this.getOwnerComponent().setModel(t,"selected_app")}}this.getView().byId("idLinkAuthToken").setText("Show");this.getView().byId("idLinkAuthTokenRefresh").setVisible(false);this.setAppIcon()},setAppIcon:function(){try{this.getView().byId("idAvatarAppIconBig").setSrc("/serverresources/app_icons/"+this._appDetail.app_id+".png?"+(new Date).getTime());this.getView().byId("idAvatarAppIconSmall").setSrc("/serverresources/app_icons/"+this._appDetail.app_id+".png?"+(new Date).getTime())}catch(e){console.log("Unable to set icon")}},onShowUsageDataPopover:function(e){if(this._appDetail.usage_tracking_id){var t=e.getSource();this._oPopover=this.getView().byId("idUsagePopover");this._oPopover.openBy(t)}},onShowASCPreviewPopover:function(e){var t=e.getSource();this._oPopover=this.getView().byId("idASCPreviewPopover");this._oPopover.openBy(t)},onUI5PopupPress:function(e){try{jQuery.sap.registerModulePath("sap.asc","/asc_ui5_lib");jQuery.sap.require("sap.asc");sap.asc.setHelpServer("");sap.asc.setAppId(this._appDetail.app_id);sap.asc.setAppVersion("");sap.asc.setAppIconUrl("./resources/images/icon_default.svg");sap.asc.setAccessToken("fd6c38f9");sap.asc.setFeedbackId("1b4f1291-e818-4d2d-892b-d8073b065a50");sap.asc.setSupportEmail("DL_55A6CA597BCF842464000002@global.corp.sap");sap.asc.init();sap.asc.open()}catch(e){console.log(e);jQuery.sap.log.error("Could not load ASC")}},onShowToken:function(e){this.api.getAppToken(this._appDetail.app_id).done(this.onGetAppTokensDone.bind(this)).fail(this.onHTTPFail.bind(this))},onRefreshToken:function(e){var t=this;sap.m.MessageBox.confirm("Are you sure you want to refresh the token? This will remove the existing token and is IRREVERSABLE!",{title:"Please confirm",initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(e){if(e==="OK"){t.api.getAppTokenRefresh(t._appDetail.app_id).done(t.onGetAppTokensDone.bind(t)).fail(t.onHTTPFail.bind(t))}}})},onContactItemPress:function(e){var t=e.getSource().getBindingContext("app_contacts").getPath();var i=t.split("/").slice(-1).pop();this.oRouter.navTo("viewappcontact",{app:this._app,app_contact:i})},onKeywordItemPress:function(e){var t=e.getSource().getBindingContext("app_keywords").getPath();var i=t.split("/").slice(-1).pop();this.oRouter.navTo("viewappkeyword",{app:this._app,app_keyword:i})},onHelpItemPress:function(e){var t=e.getSource().getBindingContext("app_help").getPath();var i=t.split("/").slice(-1).pop();this.oRouter.navTo("viewapphelp",{app:this._app,app_help:i})},onReleaseItemPress:function(e){var t=e.getSource().getBindingContext("app_releases").getPath();var i=t.split("/").slice(-1).pop();this.oRouter.navTo("viewapprelease",{app:this._app,app_release:i})},onAnnouncementsItemPress:function(e){var t=e.getSource().getBindingContext("app_announcements").getPath();var i=t.split("/").slice(-1).pop();this.oRouter.navTo("viewappannouncement",{app:this._app,app_announcement:i})},onOpenFeedbackServicePress:function(e){window.open("https://sap-it-cloud-sapitcf-feedback-feedback-approuter.cfapps.eu10.hana.ondemand.com/cp.portal/site?sap-ushell-config=standalone#feedback-Display&/topic/"+this._appDetail.feedback_service_id,"_blank")},onOpenGitURL:function(e){window.open(this._appDetail.git_url,"_blank")},onOpenUsageTrackingPress:function(e){window.open("https://fiorilaunchpad.sap.com/sites#MU-Reporting","_blank")},onFullScreenPress:function(){this.setLayout("MidColumnFullScreen")},onExitFullScreenPress:function(){this.setLayout("TwoColumnsMidExpanded")},onClosePress:function(){this.setLayout("OneColumn")},onEditAppPress:function(){this.oRouter.navTo("editapp",{app:this._app})},onDeleteAppPress:function(){var e=this;sap.m.MessageBox.confirm("Are you sure you want to delete the app? This will delete ALL associated Help, Release Notes and Announcements and is IRREVERSABLE!",{title:"Please confirm",initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(t){if(t==="OK"){e.deleteApp.bind(e)}}})},onAppIconSelect:function(e){var t=this.byId("idFileUploaderAppIcon");var i=new FormData;i.append("file",t.oFileUpload.files[0]);this.api.postAppIcon(this._appDetail.app_id,i).done(this.onPostAppIcon.bind(this)).fail(this.onHTTPFail.bind(this))},clearForm:function(){this.getView().byId("viewJamfInfoDialog").setBusy(false);this.getView().byId("idTextJamfAppName").setText("");this.getView().byId("idTextJamfAppID").setText("");this.getView().byId("idTextBundleID").setText("");this.getView().byId("idTextJamfCategory").setText("");this.getView().byId("idTextDescription").setText("");this.getView().byId("idTextJamfVersion").setText("");this.getView().byId("idTextJamfFilename").setText("");this.getView().byId("idAvatarJamfAppIcon").setSrc("");this.getView().byId("idMessageJamfNameMismatch").setVisible(false);this.getView().byId("idMessageJamfError").setVisible(true)},onDialogCloseButton:function(e){this.clearForm();this.getView().byId("viewJamfInfoDialog").close()},onGetJamfInfoForApp:function(){if(this._appDetail.bundle_id!==""&&this._appDetail.bundle_id!==null&&this._appDetail.bundle_id!=="null"){this.getView().byId("viewJamfInfoDialog").open();this.onSelectJamfSystem()}else{this.onErrorMessage("A bundle ID is required")}},onSelectJamfSystem:function(e){this.getView().byId("viewJamfInfoDialog").setBusy(true);this.sJamfSystem=this.getView().byId("idSelectJamfSystem").getSelectedKey();this.api.postJamfAppinfo(this._appDetail.bundle_id,this.sJamfSystem).done(this.onGetJamfAppInfo.bind(this)).fail(this.onGetJamfAppInfoFail.bind(this))},deleteApp:function(e){if(e=="OK"){this.api.deleteApp(this._appDetail.app_id).done(this.onRemoveAppDone.bind(this)).fail(this.onHTTPFail.bind(this))}},onUpdateJamfAppNamePress:function(e){var t=this;this.api.putJamfAppName(this._appDetail.bundle_id,{app_name:this._appDetail.app_name},this.sJamfSystem).done(function(){t.onToast("App Name in Jamf updated")}).fail(this.onGetJamfAppInfoFail.bind(this))},onGetJamfAppInfo:function(e){this.getView().byId("viewJamfInfoDialog").setBusy(false);if(e){this.getView().byId("idTextJamfAppName").setText(e.mobile_device_application.general.name);this.getView().byId("idTextJamfAppID").setText(e.mobile_device_application.general.id);this.getView().byId("idTextBundleID").setText(e.mobile_device_application.general.bundle_id);this.getView().byId("idTextJamfCategory").setText(e.mobile_device_application.general.category.name);this.getView().byId("idTextDescription").setText(e.mobile_device_application.general.description);this.getView().byId("idTextJamfVersion").setText(e.mobile_device_application.general.version);this.getView().byId("idTextJamfFilename").setText(e.mobile_device_application.general.ipa.name);this.getView().byId("idAvatarJamfAppIcon").setSrc(e.mobile_device_application.general.icon.uri);this.getView().byId("idMessageJamfError").setVisible(false);if(e.mobile_device_application.general.name!==this._appDetail.app_name){}else{this.getView().byId("idMessageJamfNameMismatch").setVisible(false)}}},onGetJamfAppInfoFail:function(){this.clearForm()},onRemoveAppDone:function(){this.onToast("App Deleted");var e=this.getView().oPropagatedProperties.oModels.apps.getData();e.splice(this._app,1);this.getView().oPropagatedProperties.oModels.apps.setData(e)},onGetAppTokensDone:function(e){this.getView().byId("idLinkAuthToken").setVisible(true);this.getView().byId("idLinkAuthTokenRefresh").setVisible(true);if(e.length>0){this.getView().byId("idLinkAuthToken").setText(e[0].token)}else{this.getView().byId("idLinkAuthToken").setText("Not found")}}})},true);